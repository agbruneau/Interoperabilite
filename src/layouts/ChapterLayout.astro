---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ChapterNav from '../components/ChapterNav.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  chapter: CollectionEntry<'chapters'>;
  prevChapter?: CollectionEntry<'chapters'> | null;
  nextChapter?: CollectionEntry<'chapters'> | null;
}

const { chapter, prevChapter, nextChapter } = Astro.props;
const { data } = chapter;
const baseUrl = import.meta.env.BASE_URL;

const domainColors = {
  verb: 'border-accent-verb',
  noun: 'border-accent-noun',
  signal: 'border-accent-signal',
  neutral: 'border-border-subtle',
};
---

<BaseLayout title={data.title} description={data.description}>
  <Header />

  <div class="flex-1 flex">
    <!-- Sidebar Navigation (Desktop) -->
    <aside class="hidden lg:block w-72 shrink-0 border-r border-border-subtle bg-bg-secondary/30">
      <div class="sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto p-6">
        <ChapterNav currentSlug={chapter.slug} />
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">
      <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Chapter Header -->
        <header class="mb-12">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-text-tertiary font-sans text-sm">
              Chapitre {data.romanNumeral}
            </span>
            {data.domainColor !== 'neutral' && (
              <span class:list={[
                'px-2 py-0.5 rounded text-xs font-sans font-medium',
                data.domainColor === 'verb' && 'bg-accent-verb/20 text-accent-verb',
                data.domainColor === 'noun' && 'bg-accent-noun/20 text-accent-noun',
                data.domainColor === 'signal' && 'bg-accent-signal/20 text-accent-signal',
              ]}>
                {data.domainColor === 'verb' && 'Le Verbe'}
                {data.domainColor === 'noun' && 'Le Nom'}
                {data.domainColor === 'signal' && 'Le Signal'}
              </span>
            )}
          </div>
          <h1 class:list={[
            'text-3xl md:text-4xl font-sans font-bold text-white pb-6 border-b-2',
            domainColors[data.domainColor || 'neutral']
          ]}>
            {data.title}
          </h1>
        </header>

        <!-- Chapter Content -->
        <div class="prose-chapter">
          <slot />
        </div>

        <!-- Chapter Navigation -->
        <nav class="mt-16 pt-8 border-t border-border-subtle">
          <div class="flex justify-between gap-4">
            {prevChapter ? (
              <a
                href={`${baseUrl}chapitres/${prevChapter.slug}`}
                class="flex-1 group p-4 rounded-lg bg-bg-secondary hover:bg-bg-tertiary transition-colors hover:no-underline"
              >
                <span class="text-text-tertiary text-sm block mb-1">← Précédent</span>
                <span class="text-white font-sans font-medium group-hover:text-accent-link">
                  {prevChapter.data.romanNumeral}. {prevChapter.data.title}
                </span>
              </a>
            ) : (
              <div class="flex-1"></div>
            )}

            {nextChapter ? (
              <a
                href={`${baseUrl}chapitres/${nextChapter.slug}`}
                class="flex-1 group p-4 rounded-lg bg-bg-secondary hover:bg-bg-tertiary transition-colors text-right hover:no-underline"
              >
                <span class="text-text-tertiary text-sm block mb-1">Suivant →</span>
                <span class="text-white font-sans font-medium group-hover:text-accent-link">
                  {nextChapter.data.romanNumeral}. {nextChapter.data.title}
                </span>
              </a>
            ) : (
              <div class="flex-1"></div>
            )}
          </div>
        </nav>
      </article>
    </main>
  </div>

  <Footer />
</BaseLayout>

<style>
  /* Ensure prose styles are applied */
  .prose-chapter :global(h1) {
    @apply text-3xl md:text-4xl font-sans font-bold text-white mb-8 mt-12 first:mt-0;
  }

  .prose-chapter :global(h2) {
    @apply text-2xl md:text-3xl font-sans font-semibold text-white mb-6 mt-12;
  }

  .prose-chapter :global(h3) {
    @apply text-xl md:text-2xl font-sans font-medium text-white mb-4 mt-8;
  }

  .prose-chapter :global(h4) {
    @apply text-lg font-sans font-medium text-text-secondary mb-3 mt-6;
  }

  .prose-chapter :global(p) {
    @apply text-text-primary leading-relaxed mb-6;
  }

  .prose-chapter :global(ul), .prose-chapter :global(ol) {
    @apply mb-6 pl-6;
  }

  .prose-chapter :global(li) {
    @apply text-text-primary mb-2;
  }

  .prose-chapter :global(blockquote) {
    @apply border-l-4 border-accent-verb pl-6 my-8 py-2;
  }

  .prose-chapter :global(blockquote p) {
    @apply text-text-primary italic;
  }

  .prose-chapter :global(blockquote strong:first-child) {
    @apply text-accent-link not-italic block mb-2;
  }

  .prose-chapter :global(pre) {
    @apply bg-bg-tertiary rounded-lg p-4 overflow-x-auto my-6 text-sm;
  }

  .prose-chapter :global(code) {
    @apply font-mono text-sm;
  }

  .prose-chapter :global(table) {
    @apply w-full my-6 border-collapse;
  }

  .prose-chapter :global(th) {
    @apply bg-bg-tertiary text-left p-3 border border-border-subtle font-sans font-semibold text-white;
  }

  .prose-chapter :global(td) {
    @apply p-3 border border-border-subtle text-text-primary;
  }

  .prose-chapter :global(hr) {
    @apply border-border-subtle my-12;
  }

  .prose-chapter :global(a) {
    @apply text-accent-link hover:underline;
  }

  .prose-chapter :global(strong) {
    @apply text-white font-semibold;
  }

  .prose-chapter :global(em) {
    @apply italic;
  }
</style>
